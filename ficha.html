<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha do Blindado</title>
    <!-- Fontes do Google -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;500;700&family=Oswald:wght@300;400;500;600&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
    <!-- Link para o novo arquivo de estilos CSS da ficha -->
    <link rel="stylesheet" href="assets/css/ficha.css">
    <!-- html2canvas CDN para salvar como PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="ficha-container" id="ficha_content_to_capture">
        <div class="document-header">
             <div class="classification-stamp">CONFIDENCIAL</div>
             <div class="content">
                <h1 id="ficha_tank_name">Carregando Ficha...</h1>
                <p class="subtitle" id="ficha_tank_type_doctrine"></p>
            </div>
        </div>

        <div class="ficha-content">
            <!-- Seção de Imagem com Upload e Seleção -->
            <div class="ficha-section image-section">
                <img id="ficha_matched_tank_image" src="https://placehold.co/600x300/4a5568/f7f3e9?text=PROJETO+CONFIDENCIAL" alt="Imagem do Blindado" class="ficha-tank-image">
                <p class="technical-note" id="image_source_text">Escolha ou carregue uma imagem de referência.</p>
                
                <div class="image-controls no-print">
                    <div class="file-upload-wrapper">
                        <input type="file" id="image_upload_input" accept="image/*" class="file-upload-input">
                        <label for="image_upload_input" class="action-button">Carregar Imagem</label>
                    </div>
                    <select id="real_tank_select" class="styled-select">
                        <option value="">Ou selecione um tanque real...</option>
                        <!-- Opções de tanques reais serão populadas via JS -->
                    </select>
                    <button id="apply_selected_tank" class="action-button">Aplicar Tanque Selecionado</button>
                </div>
            </div>

            <div class="ficha-section main-stats">
                <h3>Estatísticas de Combate</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span class="label">Vel. Estrada:</span> <span id="ficha_speed_road"></span></div>
                    <div class="stat-item"><span class="label">Vel. Off-road:</span> <span id="ficha_speed_offroad"></span></div>
                    <div class="stat-item"><span class="label">Blindagem Frontal:</span> <span id="ficha_effective_armor_front"></span></div>
                    <div class="stat-item"><span class="label">Blindagem Lateral:</span> <span id="ficha_effective_armor_side"></span></div>
                    <div class="stat-item"><span class="label">Armamento Principal:</span> <span id="ficha_main_armament"></span></div>
                    <div class="stat-item"><span class="label">Alcance Operacional:</span> <span id="ficha_max_range"></span></div>
                    <div class="stat-item"><span class="label">Conforto da Tripulação:</span> <span id="ficha_crew_comfort"></span></div>
                    <div class="stat-item"><span class="label">Confiabilidade:</span> <span id="ficha_reliability"></span></div>
                </div>
            </div>

            <div class="ficha-section detailed-info">
                <h3>Detalhes da Configuração Técnica</h3>
                <div class="info-grid">
                    <div class="info-group"><span class="info-label">País de Origem:</span> <span id="ficha_country_doctrine"></span></div>
                    <div class="info-group"><span class="info-label">Classificação:</span> <span id="ficha_vehicle_type"></span></div>
                    <div class="info-group"><span class="info-label">Tripulação:</span> <span id="ficha_num_crewmen"></span></div>
                    <div class="info-group"><span class="info-label">Peso Total:</span> <span id="ficha_total_weight"></span></div>
                    <div class="info-group"><span class="info-label">Motor:</span> <span id="ficha_engine_type"></span></div>
                    <div class="info-group"><span class="info-label">Potência:</span> <span id="ficha_total_power"></span></div>
                    <div class="info-group"><span class="info-label">Locomoção:</span> <span id="ficha_mobility_type"></span></div>
                    <div class="info-group">
                        <span class="info-label">Suspensão:</span> <span id="ficha_suspension_type"></span>
                        <p class="info-description" id="ficha_suspension_description"></p>
                    </div>
                    <div class="info-group">
                        <span class="info-label">Transmissão:</span> <span id="ficha_transmission_type"></span>
                        <p class="info-description" id="ficha_transmission_description"></p>
                    </div>
                    <div class="info-group">
                        <span class="info-label">Combustível:</span> <span id="ficha_fuel_type"></span>
                        <p class="info-description" id="ficha_fuel_description"></p>
                    </div>
                    <div class="info-group">
                        <span class="info-label">Disposição do Motor:</span> <span id="ficha_engine_disposition"></span>
                        <p class="info-description" id="ficha_engine_disposition_description"></p>
                    </div>
                    <div class="info-group">
                        <span class="info-label">Produção da Blindagem:</span> <span id="ficha_armor_production_type"></span>
                        <p class="info-description" id="ficha_armor_production_description"></p>
                    </div>
                    <div class="info-group"><span class="info-label">Blindagens Adicionais:</span> <span id="ficha_additional_armor"></span></div>
                    <div class="info-group"><span class="info-label">Comprimento do Cano:</span> <span id="ficha_main_gun_length_description"></span></div>
                    <div class="info-group">
                        <span class="info-label">Recarga:</span> <span id="ficha_reload_mechanism"></span>
                        <p class="info-description" id="ficha_reload_mechanism_description"></p>
                    </div>
                    <div class="info-group"><span class="info-label">Capacidade de Munição:</span> <span id="ficha_ammo_capacity"></span></div>
                    <div class="info-group"><span class="info-label">Munições:</span> <span id="ficha_ammo_types"></span></div>
                    <div class="info-group"><span class="info-label">Armamento Secundário:</span> <span id="ficha_secondary_armaments"></span></div>
                    <div class="info-group"><span class="info-label">Equipamentos:</span> <span id="ficha_extra_equipment"></span></div>
                    <div class="info-group"><span class="info-label">Obs. Tripulação:</span> <span id="ficha_crew_note"></span></div>
                </div>
            </div>

            <div class="ficha-section production-info">
                <h3>Relatório de Produção</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span class="label">Custo/Unidade:</span> <span id="ficha_unit_cost"></span></div>
                    <div class="stat-item"><span class="label">Custo Total (<span id="ficha_quantity_label">1x</span>):</span> <span id="ficha_total_production_cost"></span></div>
                    <div class="stat-item"><span class="label">Custo Metal (Total):</span> <span id="ficha_total_metal_cost"></span></div>
                    <div class="stat-item"><span class="label">Capacidade de Produção:</span> <span id="ficha_country_production_capacity"></span></div>
                    <div class="stat-item"><span class="label">Unidades Produzíveis:</span> <span id="ficha_producible_units"></span></div>
                    <div class="stat-item"><span class="label">Saldo de Metais:</span> <span id="ficha_country_metal_balance"></span></div>
                </div>
                <div id="ficha_metal_balance_status" class="status-indicator"></div>
                <div id="ficha_design_status" class="status-indicator"></div>
            </div>
        </div>

        <div class="ficha-actions no-print">
            <button id="save_ficha_button" class="action-button save">Salvar Ficha como PNG</button>
            <button id="back_button" class="action-button back" onclick="window.close()">Voltar ao Hangar</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tankDataString = localStorage.getItem('tankSheetData');
            const realWorldTanksString = localStorage.getItem('realWorldTanksData');
            let realWorldTanks = [];

            if (realWorldTanksString) {
                realWorldTanks = JSON.parse(realWorldTanksString);
            }

            if (tankDataString) {
                const tankData = JSON.parse(tankDataString);

                // Preencher o cabeçalho
                document.getElementById('ficha_tank_name').textContent = tankData.vehicleName;
                document.getElementById('ficha_tank_type_doctrine').textContent = `${tankData.vehicleTypeName} - Doutrina: ${tankData.doctrineName}`;

                // Preencher Estatísticas Principais
                document.getElementById('ficha_unit_cost').textContent = tankData.finalUnitCost;
                document.getElementById('ficha_total_weight').textContent = tankData.totalWeight;
                document.getElementById('ficha_total_power').textContent = tankData.totalPower;
                document.getElementById('ficha_speed_road').textContent = tankData.speedRoad;
                document.getElementById('ficha_speed_offroad').textContent = tankData.speedOffroad;
                document.getElementById('ficha_effective_armor_front').textContent = tankData.effectiveArmorFront;
                document.getElementById('ficha_effective_armor_side').textContent = tankData.effectiveArmorSide;
                document.getElementById('ficha_main_armament').textContent = tankData.mainArmamentText;
                document.getElementById('ficha_max_range').textContent = tankData.maxRange;
                document.getElementById('ficha_crew_comfort').textContent = tankData.crewComfort;
                document.getElementById('ficha_reliability').textContent = tankData.reliability;
                document.getElementById('ficha_num_crewmen').textContent = tankData.numCrewmen;

                // Preencher Detalhes da Configuração
                document.getElementById('ficha_country_doctrine').textContent = tankData.selectedCountryName;
                document.getElementById('ficha_vehicle_type').textContent = tankData.vehicleTypeName;
                document.getElementById('ficha_mobility_type').textContent = tankData.mobilityTypeName;
                document.getElementById('ficha_suspension_type').textContent = tankData.suspensionTypeName;
                document.getElementById('ficha_suspension_description').textContent = tankData.suspensionDescription || 'N/A';
                document.getElementById('ficha_engine_type').textContent = tankData.engineTypeName;
                document.getElementById('ficha_total_power').textContent = tankData.totalPower;
                document.getElementById('ficha_fuel_type').textContent = tankData.fuelTypeName;
                document.getElementById('ficha_fuel_description').textContent = tankData.fuelTypeDescription || 'N/A';
                document.getElementById('ficha_engine_disposition').textContent = tankData.engineDispositionName;
                document.getElementById('ficha_engine_disposition_description').textContent = tankData.engineDispositionDescription || 'N/A';
                document.getElementById('ficha_transmission_type').textContent = tankData.transmissionTypeName;
                document.getElementById('ficha_transmission_description').textContent = tankData.transmissionDescription || 'N/A';
                document.getElementById('ficha_armor_production_type').textContent = tankData.armorProductionTypeName;
                document.getElementById('ficha_armor_production_description').textContent = tankData.armorProductionDescription || 'N/A';
                document.getElementById('ficha_additional_armor').textContent = tankData.selectedAdditionalArmor.join(', ') || 'Nenhum';
                document.getElementById('ficha_main_gun_length_description').textContent = tankData.mainGunLengthDescription;
                document.getElementById('ficha_reload_mechanism').textContent = tankData.reloadMechanismName;
                document.getElementById('ficha_reload_mechanism_description').textContent = tankData.reloadMechanismDescription || 'N/A';
                document.getElementById('ficha_ammo_capacity').textContent = `${tankData.currentTotalAmmoQty}/${tankData.totalAmmoCapacity} projéteis`;
                document.getElementById('ficha_ammo_types').textContent = tankData.selectedAmmoTypes.join(', ') || 'Nenhum';
                document.getElementById('ficha_secondary_armaments').textContent = tankData.selectedSecondaryArmaments.join(', ') || 'Nenhum';
                document.getElementById('ficha_extra_equipment').textContent = tankData.selectedExtraEquipment.join(', ') || 'Nenhum';
                document.getElementById('ficha_crew_note').textContent = tankData.crewNoteText || 'Nenhuma observação.';

                // Preencher Informações de Produção
                document.getElementById('ficha_quantity_label').textContent = `${tankData.quantity}x`;
                document.getElementById('ficha_total_production_cost').textContent = tankData.totalProductionCost;
                document.getElementById('ficha_total_metal_cost').textContent = tankData.totalMetalCost;
                document.getElementById('ficha_country_production_capacity').textContent = tankData.countryProductionCapacity;
                document.getElementById('ficha_producible_units').textContent = tankData.producibleUnits;
                document.getElementById('ficha_country_metal_balance').textContent = tankData.countryMetalBalance;
                
                const metalStatusEl = document.getElementById('ficha_metal_balance_status');
                metalStatusEl.textContent = tankData.metalBalanceStatusText;
                metalStatusEl.className = `status-indicator ${tankData.metalBalanceStatusClass}`;

                const designStatusEl = document.getElementById('ficha_design_status');
                designStatusEl.textContent = tankData.statusMessage;
                designStatusEl.className = `status-indicator ${tankData.statusClass}`;

                // Lógica de Upload/Seleção de Imagem
                const imageUploadInput = document.getElementById('image_upload_input');
                const realTankSelect = document.getElementById('real_tank_select');
                const applySelectedTankButton = document.getElementById('apply_selected_tank');
                const fichaMatchedTankImage = document.getElementById('ficha_matched_tank_image');
                const imageSourceText = document.getElementById('image_source_text');

                realWorldTanks.sort((a, b) => a.name.localeCompare(b.name)).forEach(tank => {
                    const option = document.createElement('option');
                    option.value = tank.id;
                    option.textContent = tank.name;
                    realTankSelect.appendChild(option);
                });

                imageUploadInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            fichaMatchedTankImage.src = e.target.result;
                            imageSourceText.textContent = `Imagem personalizada para ${tankData.vehicleName}`;
                            realTankSelect.value = ""; 
                        };
                        reader.readAsDataURL(file);
                    }
                });

                applySelectedTankButton.addEventListener('click', () => {
                    const selectedTankId = realTankSelect.value;
                    if (selectedTankId) {
                        const selectedTank = realWorldTanks.find(tank => tank.id === selectedTankId);
                        if (selectedTank) {
                            fichaMatchedTankImage.src = selectedTank.image_url || 'https://placehold.co/600x300/4a5568/f7f3e9?text=IMAGEM+NÃO+DISPONÍVEL';
                            imageSourceText.textContent = `Imagem de referência: ${selectedTank.name}`;
                            imageUploadInput.value = ''; 
                        }
                    }
                });

                // Funcionalidade de salvar como PNG
                document.getElementById('save_ficha_button').addEventListener('click', () => {
                    const fichaContent = document.getElementById('ficha_content_to_capture');
                    html2canvas(fichaContent, { scale: 2, useCORS: true, logging: true }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `${tankData.vehicleName.replace(/ /g, '_')}_Ficha.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }).catch(error => {
                        console.error('Erro ao gerar a imagem da ficha:', error);
                    });
                });

            } else {
                document.getElementById('ficha_tank_name').textContent = 'Nenhum dado de tanque encontrado.';
                document.getElementById('ficha_tank_type_doctrine').textContent = 'Por favor, crie um tanque na página principal primeiro.';
                document.querySelector('.save').disabled = true;
            }
        });
    </script>
</body>
</html>
